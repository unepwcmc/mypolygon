function Activity_Marker(opts){google.maps.OverlayView.call(this);this.latlng_=opts.latlng;this.map_=opts.map;this.offsetVertical_=-20;this.offsetHorizontal_=-20;this.height_=41;this.width_=41;this.user_information_=opts.user_information;var me=this;var geodesic_line=[pa_position,this.latlng_];var geodesic_path=new google.maps.Polyline({path:geodesic_line,strokeColor:"#326696",strokeOpacity:1.0,strokeWeight:1.5,geodesic:true});geodesic_path.bindTo('map',this);}
Activity_Marker.prototype=new google.maps.OverlayView();Activity_Marker.prototype.remove=function(){if(this.div_){this.div_.parentNode.removeChild(this.div_);this.div_=null;}};Activity_Marker.prototype.draw=function(){this.createElement();if(!this.div_)return;var pixPosition=this.getProjection().fromLatLngToDivPixel(this.latlng_);if(!pixPosition)return;this.div_.style.width=this.width_+"px";this.div_.style.left=(pixPosition.x+this.offsetHorizontal_)+"px";this.div_.style.height=this.height_+"px";this.div_.style.top=(pixPosition.y+this.offsetVertical_)+"px";this.div_.style.display='block';};Activity_Marker.prototype.createElement=function(){var panes=this.getPanes();var div=this.div_;if(!div){div=this.div_=document.createElement("div");div.style.border="0px none";div.style.position="absolute";div.style.background="url('/images/activity/user_marker.png') no-repeat 0 0";div.style.width="32px";div.style.height="32px";div.style.cursor='pointer';var hiddenDiv=document.createElement('div');hiddenDiv.style.position="absolute";hiddenDiv.style.display='none';hiddenDiv.style.top='-77px';hiddenDiv.style.left='-70px';hiddenDiv.style.width="170px";hiddenDiv.style.height="63px";hiddenDiv.style.padding='7px';hiddenDiv.style.background='url(/images/activity/user_rollover.png) no-repeat 0 0';hiddenDiv.style.cursor="pointer";hiddenDiv.alt=this.user_information_.slug;var user_avatar=document.createElement("img");user_avatar.style.position="absolute";user_avatar.style.left='8px';user_avatar.style.top='7px';user_avatar.style.width="48px";user_avatar.style.height="48px";user_avatar.style.cursor="pointer";user_avatar.style.border='1px solid #cccccc';user_avatar.style.padding='3px';user_avatar.src=this.user_information_.image;hiddenDiv.appendChild(user_avatar);var user_name=document.createElement('p');user_name.style.position="relative";user_name.style.float="left";user_name.style.padding='0';user_name.style.margin='0 0 0 63px';user_name.style.font='bold 13px Arial';user_name.style.color='#006699';$(user_name).html(this.user_information_.username);user_name.style.width="103px";hiddenDiv.appendChild(user_name);var activity_ago=document.createElement('p');activity_ago.style.position="relative";activity_ago.style.float="left";activity_ago.style.padding='0';activity_ago.style.margin='0 0 0 63px';activity_ago.style.font='normal 11px Arial';activity_ago.style.color='#666666';$(activity_ago).html(this.user_information_.ago);activity_ago.style.width="103px";hiddenDiv.appendChild(activity_ago);var activity_kind=document.createElement('p');activity_kind.style.position="relative";activity_kind.style.float="left";activity_kind.style.padding='0';activity_kind.style.margin='11px 0 0 63px';activity_kind.style.font='bold 11px Arial';activity_kind.style.color='#006699';$(activity_kind).html(this.user_information_.kind);activity_kind.style.width="103px";hiddenDiv.appendChild(activity_kind);div.appendChild(hiddenDiv);function removeInfoBox(ib){return function(){ib.setMap(null);};}
$(div).hover(function(ev){lastMask++;$(this).children('div').css('z-index',lastMask+1);$(this).css('z-index',lastMask);$(this).children('div').show();$(this).children('div').hover(function(ev){$(this).hide();});},function(ev){$(this).children('div').hide();});panes.floatPane.appendChild(div);}else if(div.parentNode!=panes.floatPane){div.parentNode.removeChild(div);panes.floatPane.appendChild(div);}}
Activity_Marker.prototype.getPosition=function(){return this.latlng_;};function Fluster2ProjectionOverlay(map)
{google.maps.OverlayView.call(this);this.setMap(map);this.getP=function()
{return this.getProjection();};}
Fluster2ProjectionOverlay.prototype=new google.maps.OverlayView();Fluster2ProjectionOverlay.prototype.draw=function()
{};function Fluster2Cluster(_fluster,_marker)
{var markerPosition=_marker.getPosition();this.fluster=_fluster;this.markers=[];this.bounds=null;this.marker=null;this.lngSum=0;this.latSum=0;this.center=markerPosition;this.map=this.fluster.getMap();var me=this;var projection=_fluster.getProjection();var gridSize=_fluster.gridSize;var position=projection.fromLatLngToDivPixel(markerPosition);var positionSW=new google.maps.Point(position.x-gridSize,position.y+gridSize);var positionNE=new google.maps.Point(position.x+gridSize,position.y-gridSize);this.bounds=new google.maps.LatLngBounds(projection.fromDivPixelToLatLng(positionSW),projection.fromDivPixelToLatLng(positionNE));this.addMarker=function(_marker)
{this.markers.push(_marker);};this.show=function()
{if(this.markers.length==1)
{this.markers[0].setMap(me.map);}
else if(this.markers.length>1)
{for(var i=0;i<this.markers.length;i++)
{this.markers[i].setMap(null);}
if(this.marker==null)
{this.marker=new Fluster2ClusterMarker(this.fluster,this);if(this.fluster.debugEnabled)
{google.maps.event.addListener(this.marker,'mouseover',me.debugShowMarkers);google.maps.event.addListener(this.marker,'mouseout',me.debugHideMarkers);}}
this.marker.show();}};this.hide=function()
{if(this.marker!=null)
{this.marker.hide();}};this.debugShowMarkers=function()
{for(var i=0;i<me.markers.length;i++)
{me.markers[i].setVisible(true);}};this.debugHideMarkers=function()
{for(var i=0;i<me.markers.length;i++)
{me.markers[i].setVisible(false);}};this.getMarkerCount=function()
{return this.markers.length;};this.contains=function(_position)
{return me.bounds.contains(_position);};this.getPosition=function()
{return this.center;};this.getBounds=function()
{return this.bounds;};this.getMarkerBounds=function()
{var bounds=new google.maps.LatLngBounds(me.markers[0].getPosition(),me.markers[0].getPosition());for(var i=1;i<me.markers.length;i++)
{bounds.extend(me.markers[i].getPosition());}
return bounds;};this.addMarker(_marker);}
function Fluster2ClusterMarker(_fluster,_cluster){this.fluster=_fluster;this.cluster=_cluster;this.position=this.cluster.getPosition();this.markerCount=this.cluster.getMarkerCount();this.map=this.fluster.getMap();this.style=null;this.div=null;var styles=this.fluster.getStyles();for(var i in styles){if(this.markerCount>i){this.style=styles[i];}else{break;}}
google.maps.OverlayView.call(this);this.setMap(this.map);var geodesic_line=[pa_position,this.position];var geodesic_path=new google.maps.Polyline({path:geodesic_line,strokeColor:"#326696",strokeOpacity:1.0,strokeWeight:1.5,geodesic:true});geodesic_path.bindTo('map',this);this.draw();};Fluster2ClusterMarker.prototype=new google.maps.OverlayView();Fluster2ClusterMarker.prototype.draw=function(){if(this.div==null)
{var me=this;this.div=document.createElement('div');this.div.style.position='absolute';this.div.style.width='32px';this.div.style.height='31px';this.div.style.lineHeight='31px';this.div.style.background='transparent url("/images/activity/cluster_marker.png") 50% 50% no-repeat';this.div.style.color='#FFFFFF';this.div.style.position='relative';this.div.style.textAlign='center';this.div.style.fontFamily='Arial';this.div.style.padding='0 0 0 2px';this.div.style.fontSize='15px';this.div.style.fontWeight='bold';this.div.innerHTML=this.markerCount;this.img=document.createElement('img');this.img.src='/images/activity/view_more.png'
this.img.style.width='72px';this.img.style.height='30px';this.img.style.position='absolute';this.img.style.top='-31px';this.img.style.left='-18px';this.img.style.display='none';$(this.img).css('z-index','100000');$(this.div).append(this.img);this.div.style.cursor='pointer';google.maps.event.addDomListener(this.div,'click',function(){me.map.fitBounds(me.cluster.getMarkerBounds());});$(this.div).hover(function(ev){$(this).children('img').show();$(this).children('img').hover(function(ev){$(this).hide();});},function(ev){$(this).children('img').hide();});this.getPanes().overlayImage.appendChild(this.div);}
var position=this.getProjection().fromLatLngToDivPixel(this.position);this.div.style.left=(position.x-parseInt((this.style.width)/2))+'px';this.div.style.top=(position.y-parseInt((this.style.height)/2))+'px';};Fluster2ClusterMarker.prototype.hide=function(){this.div.style.display='none';};Fluster2ClusterMarker.prototype.show=function(){this.div.style.display='block';};function Fluster2(_map,_debug)
{var map=_map;var projection=new Fluster2ProjectionOverlay(map);var me=this;var clusters=new Object();var markersLeft=new Object();this.debugEnabled=_debug;this.gridSize=80;this.markers=new Array();this.currentZoomLevel=5;this.styles={0:{image:'http://gmaps-utility-library.googlecode.com/svn/trunk/markerclusterer/1.0/images/m1.png',textColor:'#FFFFFF',width:53,height:52},10:{image:'http://gmaps-utility-library.googlecode.com/svn/trunk/markerclusterer/1.0/images/m2.png',textColor:'#FFFFFF',width:56,height:55},20:{image:'http://gmaps-utility-library.googlecode.com/svn/trunk/markerclusterer/1.0/images/m3.png',textColor:'#FFFFFF',width:66,height:65}};var zoomChangedTimeout=null;function createClusters()
{var zoom=map.getZoom();if(clusters[zoom])
{me.debug('Clusters for zoom level '+zoom+' already initialized.');}
else
{var clustersThisZoomLevel=new Array();var clusterCount=0;var markerCount=me.markers.length;for(var i=0;i<markerCount;i++)
{var marker=me.markers[i];var markerPosition=marker.getPosition();var done=false;for(var j=clusterCount-1;j>=0;j--)
{var cluster=clustersThisZoomLevel[j];if(cluster.contains(markerPosition))
{cluster.addMarker(marker);done=true;break;}}
if(!done)
{var cluster=new Fluster2Cluster(me,marker);clustersThisZoomLevel.push(cluster);clusterCount++;}}
clusters[zoom]=clustersThisZoomLevel;me.debug('Initialized '+clusters[zoom].length+' clusters for zoom level '+zoom+'.');}
if(clusters[me.currentZoomLevel])
{for(var i=0;i<clusters[me.currentZoomLevel].length;i++)
{clusters[me.currentZoomLevel][i].hide();}}
me.currentZoomLevel=zoom;showClustersInBounds();}
function showClustersInBounds()
{var mapBounds=map.getBounds();for(var i=0;i<clusters[me.currentZoomLevel].length;i++)
{var cluster=clusters[me.currentZoomLevel][i];if(mapBounds.contains(cluster.getPosition()))
{cluster.show();}}}
this.zoomChanged=function()
{window.clearInterval(zoomChangedTimeout);zoomChangedTimeout=window.setTimeout(createClusters,500);};this.getMap=function()
{return map;};this.getProjection=function()
{return projection.getP();};this.debug=function(message)
{if(me.debugEnabled)
{console.log('Fluster2: '+message);}};this.addMarker=function(_marker)
{me.markers.push(_marker);};this.getStyles=function()
{return me.styles;};this.initialize=function()
{google.maps.event.addListener(map,'zoom_changed',this.zoomChanged);google.maps.event.addListener(map,'dragend',showClustersInBounds);window.setTimeout(createClusters,1000);};function clearAll()
{for(var i=0;i<15;i++)
{for(var j=0;clusters[i]&&j<clusters[i].length;j++)
{if(clusters[i][j].marker)
clusters[i][j].marker.setMap(null);clusters[i][j].hide();clusters[i][j]=null;}
clusters[i]=null;}
for(i=0;i<me.markers.length;i++){me.markers[i].setMap(null);}
me.markers=new Array();clusters=new Object();}
this.clearMarkers=function()
{clearAll();};}
var editRecordsList;var editRecordsListCompressed;$(document).ready(function(){$('.myselectbox').selectbox();editRecordsList=$('div#right_container div.protected_area ul').height();$('div#right_container div.protected_area ul li .last').hide();editRecordsListCompressed=$('div#right_container div.protected_area ul').height();$("#view_more").click(function(ev){var sizeContainer=$('div#right_container div.protected_area').height();if(sizeContainer<editRecordsList){$('div#right_container div.protected_area ul li .last').show();$('div#right_container div.protected_area ul').animate({height:editRecordsList},500);$('#view_more').css('background-position','40px -18px');$('#view_more').css('padding-left','50px');$('#view_more').text('close');}else{$('div#right_container div.protected_area ul').animate({height:editRecordsListCompressed},500,function(){$('div#right_container div.protected_area ul li .last').hide();});$('#view_more').css('background-position','24px 4px');$('#view_more').css('padding-left','36px');$('#view_more').text('view more');}});$("div#right_container div.view_more").hover(function(ev){$('div#right_container div.protected_area').css('border-color','#254C72');},function(ev){$('div#right_container div.protected_area').css('border-color','#cccccc');});$("li .conflict").hover(function(ev){$(this).children('div.message').fadeIn();},function(ev){$(this).children('div.message').fadeOut();});$('a.tipsy').tipsy({fade:true,gravity:'s'});$('a.tipsy_conflict').tipsy({fade:true,gravity:'s'});$('img.tipwhee').tipsy({fade:false,gravity:'e'});$('a.what_is_this').tipsy({fade:true,gravity:'s'});$('#mycarousel').jcarousel({initCallback:mycarousel_initCallback,buttonNextHTML:null,buttonPrevHTML:null,size:3,scroll:1,start:1,vertical:true});$('#edit_data_container div.data_edit div span a').hover(function(){$(this).children('div.tooltip').show();},function(){$(this).children('div.tooltip').hide();});$('#open_edit_container').click(function(ev){ev.preventDefault();var height_mamufas=$(document).height();var width_mamufas=$(document).width();$('div#mamufas').css('height',height_mamufas+'px');$('div#mamufas').css('width',width_mamufas+'px');var position=$('div#right_container').position();$('div#mamufas').fadeIn('fast',function(ev){$.scrollTo('div#right_container',300,function(ev){$('#edit_data_container').css('left',position.left-10+'px');$('#edit_data_container').css('top',(position.top+20)+'px');$('#edit_data_container').fadeIn('fast');});});});$('a.create_comment').click(function(ev){ev.preventDefault();ev.stopPropagation();var position=$('a#loginLink').offset();$("div#signUp").css("left",position.left-185+"px");$("div#signUp").css("top",position.top-14+"px");$('div#signUp').fadeIn('fast');$.scrollTo('div#header',500,function(){$('#username_field_home').focus();$('div.login_tooltip').fadeIn('fast').delay(2000).fadeOut('slow');});});$('a.create_bottom_comment').click(function(ev){ev.preventDefault();ev.stopPropagation();var position=$('a#loginLink').offset();$("div#signUp").css("left",position.left-185+"px");$("div#signUp").css("top",position.top-14+"px");$('div#signUp').fadeIn('fast');$.scrollTo('div#header',500,function(){$('#username_field_home').focus();$('div.login_tooltip').fadeIn('fast').delay(2000).fadeOut('slow');});});$('#edit_close').click(function(ev){ev.preventDefault();});$('#cancel_close').click(function(ev){ev.preventDefault();$('#edit_data_container').fadeOut();$('#mamufas').fadeOut();});$('div#left_container div.latest_from li div.opinion a').click(function(ev){if($(this).parent().parent().find('div.visible').is(':visible')){$(this).parent().parent().find('div.visible').hide();$(this).hover(function(){$(this).children('span.dif').css('background','url(/images/common/download_right.gif) no-repeat right -27px');$(this).children('span.dif').css('color','#333333');},function(){$(this).children('span.dif').css('background','url(/images/common/download_right.gif) no-repeat right 0');$(this).children('span.dif').css('color','#666666');})
ev.preventDefault();}else{$(this).parent().parent().find('div.visible').show();$(this).hover(function(){$(this).children('span.dif').css('background','url(/images/common/download_right.gif) no-repeat right -27px');$(this).children('span.dif').css('color','#333333');},function(){$(this).children('span.dif').css('background','url(/images/common/download_right.gif) no-repeat right -27px');$(this).children('span.dif').css('color','#333333');})
ev.preventDefault();}});$('div#right_container div.gallery ul li div.pic_area').live('mouseenter',function(){$(this).css('z-index','9999');$(this).parent().find('div.hidden').show();});$('div#right_container div.gallery ul li div.pic_area').live('mouseleave',function(){$(this).css('z-index','1');$(this).parent().find('div.hidden').hide();});var zIndexNumber=1000;$('div.pic_area').each(function(){$(this).css('zIndex',zIndexNumber);zIndexNumber-=10;});});var map;var fluster;var bounds;var pa_marker;var pa_position;var lastMask=10000;$(document).ready(function(){var height_content=$('div#upper_area div.content').height();$('a#zoom_in').css('top',height_content+15+'px');$('a#zoom_out').css('top',height_content+15+'px');$('a#terrain').css('top',height_content+15+'px');$('a#satellite').css('top',height_content+15+'px');$('a#zoom_in').fadeIn();$('a#zoom_out').fadeIn();$('a#terrain').fadeIn();$('a#satellite').fadeIn();$('a#zoom_in').click(function(ev){ev.stopPropagation();ev.preventDefault();map.setZoom(map.getZoom()+1);});$('a#zoom_out').click(function(ev){ev.stopPropagation();ev.preventDefault();map.setZoom(map.getZoom()-1);});$('a#satellite').click(function(ev){ev.stopPropagation();ev.preventDefault();if(!$(this).hasClass('selected')){$('a#terrain').removeClass('selected');$('a#satellite').addClass('selected');map.setMapTypeId(google.maps.MapTypeId.SATELLITE);}});$('a#terrain').click(function(ev){ev.stopPropagation();ev.preventDefault();if(!$(this).hasClass('selected')){$('a#satellite').removeClass('selected');$('a#terrain').addClass('selected');map.setMapTypeId(google.maps.MapTypeId.TERRAIN);}});$('a#terrain').addClass('selected');var url_request=$('#activity_json_link').attr('href');var script=document.createElement('script');script.setAttribute('src',url_request+'?callback=loadJson');script.setAttribute('id','jsonScript');script.setAttribute('type','text/javascript');document.documentElement.firstChild.appendChild(script);});function loadJson(json){var myOptions={zoom:12,center:new google.maps.LatLng(0,0),disableDefaultUI:true,scrollwheel:false,mapTypeId:google.maps.MapTypeId.TERRAIN};map=new google.maps.Map(document.getElementById("js_map"),myOptions);pa_position=new google.maps.LatLng(json.site.y,json.site.x);fluster=new Fluster2(map);bounds=new google.maps.LatLngBounds();bounds.extend(new google.maps.LatLng(json.site.y,json.site.x));if(json.activities.length!=0){for(var i=0;i<json.activities.length;i++){var user_information=new Object();user_information.username=json.activities[i].username;user_information.ago=json.activities[i].created_at;user_information.kind=json.activities[i].type;user_information.image=json.activities[i].image;var marker=new Activity_Marker({latlng:new google.maps.LatLng(json.activities[i].y,json.activities[i].x),map:null,user_information:user_information});fluster.addMarker(marker);bounds.extend(new google.maps.LatLng(json.activities[i].y,json.activities[i].x));}}
fluster.currentZoomLevel=map.getZoom();fluster.styles={0:{image:'/images/activity/cluster_marker.png',textColor:'#FFFFFF',width:32,height:31},10:{image:'/images/activity/cluster_marker.png',textColor:'#FFFFFF',width:32,height:31},20:{image:'/images/activity/cluster_marker.png',textColor:'#FFFFFF',width:32,height:31},30:{image:'/images/activity/cluster_marker.png',textColor:'#FFFFFF',width:32,height:31}};var image=new google.maps.MarkerImage('/images/activity/pa_marker.png',new google.maps.Size(84,84),new google.maps.Point(0,0),new google.maps.Point(42,42));pa_marker=new google.maps.Marker({position:new google.maps.LatLng(json.site.y,json.site.x),title:json.site.url_slug,icon:image});pa_marker.setMap(map);map.fitBounds(bounds);map.setCenter(bounds.getCenter());fluster.initialize();}
function loadMoreActivities(json){old_markers=fluster.markers;fluster.clearMarkers();fluster=new Fluster2(map);for(var m in old_markers){fluster.addMarker(old_markers[m]);}
if(json.activities.length!=0){for(var i=0;i<json.activities.length;i++){var user_information=new Object();user_information.username=json.activities[i].username;user_information.ago=json.activities[i].created_at;user_information.kind=json.activities[i].type;user_information.image=json.activities[i].image;var marker=new Activity_Marker({latlng:new google.maps.LatLng(json.activities[i].y,json.activities[i].x),map:null,user_information:user_information});fluster.addMarker(marker);bounds.extend(new google.maps.LatLng(json.activities[i].y,json.activities[i].x));}}
fluster.currentZoomLevel=map.getZoom();var image=new google.maps.MarkerImage('/images/activity/pa_marker.png',new google.maps.Size(84,84),new google.maps.Point(0,0),new google.maps.Point(42,42));map.fitBounds(bounds);map.setCenter(bounds.getCenter());fluster.initialize();}